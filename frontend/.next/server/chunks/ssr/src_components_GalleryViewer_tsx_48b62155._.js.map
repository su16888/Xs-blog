{"version":3,"sources":["../../../../src/components/GalleryViewer.tsx"],"sourcesContent":["/**\r\n * @file GalleryViewer.tsx\r\n * @description 图册查看器组件 - 支持密码验证、图片预览、放大缩小、左右切换、下载等功能\r\n * @author Arran\r\n * @copyright 2025 Arran ( SuMoChen)\r\n * @version 1.0.0\r\n * @created 2025-11-25\r\n */\r\n\r\n'use client';\r\n\r\nimport { useState, useEffect, useRef, useCallback } from 'react';\r\nimport { createPortal } from 'react-dom';\r\nimport { motion, AnimatePresence } from 'framer-motion';\r\nimport {\r\n  X,\r\n  ChevronLeft,\r\n  ChevronRight,\r\n  ZoomIn,\r\n  ZoomOut,\r\n  Download,\r\n  Lock,\r\n  Eye,\r\n  EyeOff\r\n} from 'lucide-react';\r\nimport { getGallery, verifyGalleryPassword } from '@/lib/api';\r\nimport { getFileUrl } from '@/lib/utils';\r\n\r\ninterface GalleryImage {\r\n  id: number;\r\n  filename: string;\r\n  path: string;\r\n  sort_order: number;\r\n  size?: number;\r\n}\r\n\r\ninterface Gallery {\r\n  id: number;\r\n  title: string;\r\n  description?: string;\r\n  images: GalleryImage[];\r\n  password?: string;\r\n}\r\n\r\ninterface GalleryViewerProps {\r\n  galleryId: number;\r\n  isOpen: boolean;\r\n  onClose: () => void;\r\n}\r\n\r\nexport default function GalleryViewer({ galleryId, isOpen, onClose }: GalleryViewerProps) {\r\n  const [gallery, setGallery] = useState<Gallery | null>(null);\r\n  const [currentImageIndex, setCurrentImageIndex] = useState(0);\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [zoom, setZoom] = useState(1);\r\n  const [requirePassword, setRequirePassword] = useState(false);\r\n  const [password, setPassword] = useState('');\r\n  const [passwordError, setPasswordError] = useState('');\r\n  const [showPassword, setShowPassword] = useState(false);\r\n  const [verifyingPassword, setVerifyingPassword] = useState(false);\r\n\r\n  // 检测是否为移动端\r\n  const [isMobile, setIsMobile] = useState(false);\r\n\r\n  // 图片拖动相关状态\r\n  const [position, setPosition] = useState({ x: 0, y: 0 });\r\n  const [isDragging, setIsDragging] = useState(false);\r\n  const dragStart = useRef({ x: 0, y: 0 });\r\n  const lastPosition = useRef({ x: 0, y: 0 });\r\n\r\n  // 双指缩放相关状态\r\n  const [initialPinchDistance, setInitialPinchDistance] = useState<number | null>(null);\r\n  const [initialZoom, setInitialZoom] = useState(1);\r\n\r\n  // 触摸滑动相关状态（用于切换图片）\r\n  const [touchStart, setTouchStart] = useState<{ x: number; y: number } | null>(null);\r\n  const [touchEnd, setTouchEnd] = useState<{ x: number; y: number } | null>(null);\r\n  const [isSwiping, setIsSwiping] = useState(false);\r\n\r\n  // 缩略图容器引用\r\n  const thumbnailContainerRef = useRef<HTMLDivElement>(null);\r\n  const thumbnailRefs = useRef<(HTMLButtonElement | null)[]>([]);\r\n\r\n  // 滑动最小距离（像素）\r\n  const minSwipeDistance = 50;\r\n\r\n  // 检测移动端\r\n  useEffect(() => {\r\n    const checkMobile = () => {\r\n      setIsMobile(window.innerWidth < 768 || 'ontouchstart' in window);\r\n    };\r\n    checkMobile();\r\n    window.addEventListener('resize', checkMobile);\r\n    return () => window.removeEventListener('resize', checkMobile);\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (isOpen && galleryId) {\r\n      loadGallery();\r\n    }\r\n  }, [isOpen, galleryId]);\r\n\r\n  useEffect(() => {\r\n    if (isOpen) {\r\n      document.body.style.overflow = 'hidden';\r\n    } else {\r\n      document.body.style.overflow = 'unset';\r\n    }\r\n\r\n    return () => {\r\n      document.body.style.overflow = 'unset';\r\n    };\r\n  }, [isOpen]);\r\n\r\n  // 当图片切换时，滚动缩略图到可见位置\r\n  useEffect(() => {\r\n    if (thumbnailContainerRef.current && thumbnailRefs.current[currentImageIndex]) {\r\n      const container = thumbnailContainerRef.current;\r\n      const thumbnail = thumbnailRefs.current[currentImageIndex];\r\n      if (thumbnail) {\r\n        const containerRect = container.getBoundingClientRect();\r\n        const thumbnailRect = thumbnail.getBoundingClientRect();\r\n\r\n        // 计算缩略图相对于容器的位置\r\n        const thumbnailLeft = thumbnailRect.left - containerRect.left + container.scrollLeft;\r\n        const thumbnailRight = thumbnailLeft + thumbnailRect.width;\r\n        const containerWidth = containerRect.width;\r\n\r\n        // 如果缩略图不在可见区域内，滚动到中间位置\r\n        if (thumbnailLeft < container.scrollLeft || thumbnailRight > container.scrollLeft + containerWidth) {\r\n          const scrollTo = thumbnailLeft - containerWidth / 2 + thumbnailRect.width / 2;\r\n          container.scrollTo({\r\n            left: Math.max(0, scrollTo),\r\n            behavior: 'smooth'\r\n          });\r\n        }\r\n      }\r\n    }\r\n  }, [currentImageIndex]);\r\n\r\n  // 键盘导航\r\n  useEffect(() => {\r\n    if (!isOpen) return;\r\n\r\n    const handleKeyDown = (e: KeyboardEvent) => {\r\n      if (e.key === 'Escape') {\r\n        onClose();\r\n      } else if (e.key === 'ArrowLeft') {\r\n        handlePrevious();\r\n      } else if (e.key === 'ArrowRight') {\r\n        handleNext();\r\n      } else if (e.key === '+' || e.key === '=') {\r\n        handleZoomIn();\r\n      } else if (e.key === '-') {\r\n        handleZoomOut();\r\n      }\r\n    };\r\n\r\n    window.addEventListener('keydown', handleKeyDown);\r\n    return () => window.removeEventListener('keydown', handleKeyDown);\r\n  }, [isOpen, currentImageIndex, zoom, gallery]);\r\n\r\n  // 电脑端鼠标滚轮缩放\r\n  const handleWheel = useCallback((e: React.WheelEvent) => {\r\n    if (isMobile) return;\r\n\r\n    e.preventDefault();\r\n    const delta = e.deltaY > 0 ? -0.1 : 0.1;\r\n    setZoom((prev) => {\r\n      const newZoom = Math.min(Math.max(prev + delta, 0.5), 3);\r\n      // 如果缩放回到1，重置位置\r\n      if (newZoom <= 1) {\r\n        setPosition({ x: 0, y: 0 });\r\n      }\r\n      return newZoom;\r\n    });\r\n  }, [isMobile]);\r\n\r\n  // 电脑端鼠标拖动\r\n  const handleMouseDown = useCallback((e: React.MouseEvent) => {\r\n    if (isMobile || zoom <= 1) return;\r\n    e.preventDefault();\r\n    setIsDragging(true);\r\n    dragStart.current = { x: e.clientX - position.x, y: e.clientY - position.y };\r\n  }, [isMobile, zoom, position]);\r\n\r\n  const handleMouseMove = useCallback((e: React.MouseEvent) => {\r\n    if (!isDragging || isMobile) return;\r\n    const newX = e.clientX - dragStart.current.x;\r\n    const newY = e.clientY - dragStart.current.y;\r\n    setPosition({ x: newX, y: newY });\r\n  }, [isDragging, isMobile]);\r\n\r\n  const handleMouseUp = useCallback(() => {\r\n    setIsDragging(false);\r\n  }, []);\r\n\r\n  // 计算两指之间的距离\r\n  const getDistance = (touches: React.TouchList) => {\r\n    if (touches.length < 2) return 0;\r\n    const dx = touches[0].clientX - touches[1].clientX;\r\n    const dy = touches[0].clientY - touches[1].clientY;\r\n    return Math.sqrt(dx * dx + dy * dy);\r\n  };\r\n\r\n  // 处理触摸开始\r\n  const onTouchStart = (e: React.TouchEvent) => {\r\n    if (e.touches.length === 2) {\r\n      // 双指缩放开始\r\n      setInitialPinchDistance(getDistance(e.touches));\r\n      setInitialZoom(zoom);\r\n      setIsSwiping(false);\r\n    } else if (e.touches.length === 1) {\r\n      const touch = e.touches[0];\r\n      if (zoom > 1) {\r\n        // 放大状态下拖动\r\n        setIsDragging(true);\r\n        dragStart.current = { x: touch.clientX - position.x, y: touch.clientY - position.y };\r\n      } else {\r\n        // 正常状态下滑动切换\r\n        setTouchStart({ x: touch.clientX, y: touch.clientY });\r\n        setTouchEnd(null);\r\n        setIsSwiping(true);\r\n      }\r\n    }\r\n  };\r\n\r\n  // 处理触摸移动\r\n  const onTouchMove = (e: React.TouchEvent) => {\r\n    if (e.touches.length === 2 && initialPinchDistance) {\r\n      // 双指缩放\r\n      const currentDistance = getDistance(e.touches);\r\n      const scale = currentDistance / initialPinchDistance;\r\n      const newZoom = Math.min(Math.max(initialZoom * scale, 0.5), 3);\r\n      setZoom(newZoom);\r\n      if (newZoom <= 1) {\r\n        setPosition({ x: 0, y: 0 });\r\n      }\r\n    } else if (e.touches.length === 1) {\r\n      const touch = e.touches[0];\r\n      if (isDragging && zoom > 1) {\r\n        // 放大状态下拖动\r\n        const newX = touch.clientX - dragStart.current.x;\r\n        const newY = touch.clientY - dragStart.current.y;\r\n        setPosition({ x: newX, y: newY });\r\n      } else if (isSwiping && zoom <= 1) {\r\n        // 正常状态下记录滑动位置\r\n        setTouchEnd({ x: touch.clientX, y: touch.clientY });\r\n      }\r\n    }\r\n  };\r\n\r\n  // 处理触摸结束\r\n  const onTouchEnd = () => {\r\n    setInitialPinchDistance(null);\r\n    setIsDragging(false);\r\n\r\n    // 处理滑动切换\r\n    if (isSwiping && touchStart && touchEnd && zoom <= 1) {\r\n      const distanceX = touchStart.x - touchEnd.x;\r\n      const distanceY = Math.abs(touchStart.y - touchEnd.y);\r\n\r\n      // 确保是水平滑动（水平距离大于垂直距离）\r\n      if (Math.abs(distanceX) > distanceY && Math.abs(distanceX) > minSwipeDistance) {\r\n        if (distanceX > 0) {\r\n          handleNext();\r\n        } else {\r\n          handlePrevious();\r\n        }\r\n      }\r\n    }\r\n\r\n    setIsSwiping(false);\r\n    setTouchStart(null);\r\n    setTouchEnd(null);\r\n  };\r\n\r\n  const loadGallery = async (pwd?: string) => {\r\n    setLoading(true);\r\n    setError(null);\r\n\r\n    try {\r\n      const response = await getGallery(galleryId, pwd);\r\n\r\n      if (response.success) {\r\n        setGallery(response.data);\r\n        setRequirePassword(false);\r\n        setPasswordError('');\r\n      } else if (response.requirePassword) {\r\n        setRequirePassword(true);\r\n      } else {\r\n        setError(response.message || '加载图册失败');\r\n      }\r\n    } catch (err: any) {\r\n      if (err.response?.status === 401) {\r\n        if (err.response?.data?.requirePassword) {\r\n          setRequirePassword(true);\r\n        } else {\r\n          setRequirePassword(true);\r\n          setPasswordError('密码错误');\r\n        }\r\n      } else {\r\n        setError('加载图册失败');\r\n      }\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handlePasswordSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n\r\n    if (!password.trim()) {\r\n      setPasswordError('请输入密码');\r\n      return;\r\n    }\r\n\r\n    setVerifyingPassword(true);\r\n    setPasswordError('');\r\n\r\n    try {\r\n      await loadGallery(password);\r\n    } catch (err) {\r\n      // Error handled in loadGallery\r\n    } finally {\r\n      setVerifyingPassword(false);\r\n    }\r\n  };\r\n\r\n  const handleNext = () => {\r\n    if (!gallery || gallery.images.length === 0) return;\r\n    setCurrentImageIndex((prev) => (prev + 1) % gallery.images.length);\r\n    resetZoomAndPosition();\r\n  };\r\n\r\n  const handlePrevious = () => {\r\n    if (!gallery || gallery.images.length === 0) return;\r\n    setCurrentImageIndex((prev) => (prev - 1 + gallery.images.length) % gallery.images.length);\r\n    resetZoomAndPosition();\r\n  };\r\n\r\n  const resetZoomAndPosition = () => {\r\n    setZoom(1);\r\n    setPosition({ x: 0, y: 0 });\r\n  };\r\n\r\n  const handleZoomIn = () => {\r\n    setZoom((prev) => Math.min(prev + 0.25, 3));\r\n  };\r\n\r\n  const handleZoomOut = () => {\r\n    setZoom((prev) => {\r\n      const newZoom = Math.max(prev - 0.25, 0.5);\r\n      if (newZoom <= 1) {\r\n        setPosition({ x: 0, y: 0 });\r\n      }\r\n      return newZoom;\r\n    });\r\n  };\r\n\r\n  const handleDownloadCurrent = () => {\r\n    if (!gallery || gallery.images.length === 0) return;\r\n\r\n    const currentImage = gallery.images[currentImageIndex];\r\n    const imageUrl = getFileUrl(currentImage.path);\r\n\r\n    const link = document.createElement('a');\r\n    link.href = imageUrl;\r\n    link.download = currentImage.filename;\r\n    link.target = '_blank';\r\n    document.body.appendChild(link);\r\n    link.click();\r\n    document.body.removeChild(link);\r\n  };\r\n\r\n  const handleClose = () => {\r\n    setZoom(1);\r\n    setPosition({ x: 0, y: 0 });\r\n    setCurrentImageIndex(0);\r\n    setGallery(null);\r\n    setRequirePassword(false);\r\n    setPassword('');\r\n    setPasswordError('');\r\n    onClose();\r\n  };\r\n\r\n  if (!isOpen) return null;\r\n\r\n  const modalContent = (\r\n    <AnimatePresence>\r\n      <motion.div\r\n        initial={{ opacity: 0 }}\r\n        animate={{ opacity: 1 }}\r\n        exit={{ opacity: 0 }}\r\n        className=\"fixed inset-0 z-[99999] flex items-center justify-center bg-black/90 backdrop-blur-sm\"\r\n        onClick={handleClose}\r\n      >\r\n        <div\r\n          className=\"relative w-full h-full flex flex-col\"\r\n          onClick={(e) => e.stopPropagation()}\r\n        >\r\n          {/* 顶部工具栏 */}\r\n          <div className=\"absolute top-0 left-0 right-0 z-10 bg-gradient-to-b from-black/80 to-transparent p-4\">\r\n            <div className=\"flex items-center justify-between max-w-7xl mx-auto\">\r\n              <div className=\"w-10\"></div>\r\n\r\n              <div className=\"flex-1 flex justify-center\">\r\n                {!loading && !requirePassword && gallery && gallery.images.length > 1 && (\r\n                  <div className=\"bg-black/50 backdrop-blur-sm rounded-full px-4 py-2\">\r\n                    <span className=\"text-white text-sm font-medium\">\r\n                      {currentImageIndex + 1} / {gallery.images.length}\r\n                    </span>\r\n                  </div>\r\n                )}\r\n              </div>\r\n\r\n              <div className=\"flex items-center gap-2\">\r\n                {!loading && !requirePassword && gallery && gallery.images.length > 0 && (\r\n                  <button\r\n                    onClick={handleDownloadCurrent}\r\n                    className=\"p-2 bg-white/10 hover:bg-white/20 rounded-lg transition-colors\"\r\n                    title=\"下载当前图片\"\r\n                  >\r\n                    <Download className=\"w-5 h-5 text-white\" />\r\n                  </button>\r\n                )}\r\n\r\n                {!requirePassword && (\r\n                  <button\r\n                    onClick={handleClose}\r\n                    className=\"p-2 bg-white/10 hover:bg-white/20 rounded-lg transition-colors\"\r\n                    title=\"关闭\"\r\n                  >\r\n                    <X className=\"w-5 h-5 text-white\" />\r\n                  </button>\r\n                )}\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* 中间内容区域 */}\r\n          <div className=\"flex-1 flex flex-col items-center justify-center\">\r\n            {loading && (\r\n              <div className=\"text-center\">\r\n                <div className=\"inline-block animate-spin rounded-full h-12 w-12 border-4 border-white border-t-transparent mb-4\"></div>\r\n                <p className=\"text-white\">加载中...</p>\r\n              </div>\r\n            )}\r\n\r\n            {error && (\r\n              <div className=\"text-center\">\r\n                <p className=\"text-red-400 text-lg mb-4\">{error}</p>\r\n                <button\r\n                  onClick={handleClose}\r\n                  className=\"px-6 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg transition-colors\"\r\n                >\r\n                  关闭\r\n                </button>\r\n              </div>\r\n            )}\r\n\r\n            {requirePassword && (\r\n              <motion.div\r\n                initial={{ scale: 0.95, opacity: 0 }}\r\n                animate={{ scale: 1, opacity: 1 }}\r\n                transition={{ duration: 0.2 }}\r\n                className=\"w-full max-w-sm bg-bg-secondary rounded-xl p-5 shadow-xl border border-border-primary relative mx-4\"\r\n              >\r\n                <button\r\n                  onClick={handleClose}\r\n                  className=\"absolute top-4 right-4 p-1.5 text-text-tertiary hover:text-text-primary hover:bg-bg-tertiary rounded-lg transition-colors\"\r\n                  title=\"关闭\"\r\n                  disabled={verifyingPassword}\r\n                >\r\n                  <X className=\"w-5 h-5\" />\r\n                </button>\r\n\r\n                <div className=\"text-center mb-5\">\r\n                  <div className=\"w-12 h-12 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-3\">\r\n                    <Lock className=\"w-6 h-6 text-primary-600\" />\r\n                  </div>\r\n                  <h3 className=\"text-base font-bold text-text-primary mb-1\">\r\n                    需要密码访问\r\n                  </h3>\r\n                  <p className=\"text-xs text-text-tertiary\">\r\n                    请输入密码查看图册内容\r\n                  </p>\r\n                </div>\r\n\r\n                <form onSubmit={handlePasswordSubmit} className=\"space-y-3\">\r\n                  <div>\r\n                    <div className=\"relative\">\r\n                      <input\r\n                        type={showPassword ? 'text' : 'password'}\r\n                        name=\"gallery-access-password\"\r\n                        value={password}\r\n                        onChange={(e) => {\r\n                          setPassword(e.target.value);\r\n                          setPasswordError('');\r\n                        }}\r\n                        placeholder=\"请输入密码\"\r\n                        className={`w-full px-3 py-2.5 pr-10 text-sm border ${\r\n                          passwordError ? 'border-red-500' : 'border-border-primary'\r\n                        } rounded-lg bg-bg-tertiary text-text-primary focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent`}\r\n                        autoFocus\r\n                        autoComplete=\"off\"\r\n                        disabled={verifyingPassword}\r\n                      />\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() => setShowPassword(!showPassword)}\r\n                        className=\"absolute right-3 top-1/2 -translate-y-1/2 text-text-tertiary hover:text-text-primary transition-colors\"\r\n                      >\r\n                        {showPassword ? (\r\n                          <EyeOff className=\"w-4 h-4\" />\r\n                        ) : (\r\n                          <Eye className=\"w-4 h-4\" />\r\n                        )}\r\n                      </button>\r\n                    </div>\r\n                    {passwordError && (\r\n                      <p className=\"mt-1.5 text-xs text-red-500\">{passwordError}</p>\r\n                    )}\r\n                  </div>\r\n\r\n                  <button\r\n                    type=\"submit\"\r\n                    className=\"w-full px-3 py-2 text-sm bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors disabled:opacity-50\"\r\n                    disabled={verifyingPassword || !password}\r\n                  >\r\n                    {verifyingPassword ? '验证中...' : '确认'}\r\n                  </button>\r\n                </form>\r\n              </motion.div>\r\n            )}\r\n\r\n            {!loading && !error && !requirePassword && gallery && gallery.images.length > 0 && (\r\n              <>\r\n                <div className=\"h-20\"></div>\r\n\r\n                {/* 图片容器 */}\r\n                <div\r\n                  className=\"relative flex-shrink-0 px-4 lg:px-24\"\r\n                  onWheel={handleWheel}\r\n                  onMouseDown={handleMouseDown}\r\n                  onMouseMove={handleMouseMove}\r\n                  onMouseUp={handleMouseUp}\r\n                  onMouseLeave={handleMouseUp}\r\n                  onTouchStart={onTouchStart}\r\n                  onTouchMove={onTouchMove}\r\n                  onTouchEnd={onTouchEnd}\r\n                  style={{ cursor: zoom > 1 ? (isDragging ? 'grabbing' : 'grab') : 'default' }}\r\n                >\r\n                  <motion.img\r\n                    key={currentImageIndex}\r\n                    src={getFileUrl(gallery.images[currentImageIndex].path)}\r\n                    alt={gallery.images[currentImageIndex].filename}\r\n                    className=\"max-w-full object-contain mx-auto select-none\"\r\n                    draggable={false}\r\n                    style={{\r\n                      transform: `scale(${zoom}) translate(${position.x / zoom}px, ${position.y / zoom}px)`,\r\n                      transition: isDragging ? 'none' : 'transform 0.2s ease-out',\r\n                      maxHeight: 'calc(100vh - 320px)',\r\n                      maxWidth: '100%',\r\n                      touchAction: 'none'\r\n                    }}\r\n                    initial={{ opacity: 0 }}\r\n                    animate={{ opacity: 1 }}\r\n                    exit={{ opacity: 0 }}\r\n                  />\r\n\r\n                  {/* 左右切换按钮 - 仅电脑端显示 */}\r\n                  {gallery.images.length > 1 && !isMobile && (\r\n                    <>\r\n                      <button\r\n                        onClick={handlePrevious}\r\n                        className=\"absolute -left-16 top-1/2 -translate-y-1/2 p-3 bg-black/20 hover:bg-black/40 rounded-full transition-colors backdrop-blur-sm\"\r\n                        title=\"上一张 (←)\"\r\n                      >\r\n                        <ChevronLeft className=\"w-6 h-6 text-white/60\" />\r\n                      </button>\r\n\r\n                      <button\r\n                        onClick={handleNext}\r\n                        className=\"absolute -right-16 top-1/2 -translate-y-1/2 p-3 bg-black/20 hover:bg-black/40 rounded-full transition-colors backdrop-blur-sm\"\r\n                        title=\"下一张 (→)\"\r\n                      >\r\n                        <ChevronRight className=\"w-6 h-6 text-white/60\" />\r\n                      </button>\r\n                    </>\r\n                  )}\r\n                </div>\r\n\r\n                <div className=\"h-20\"></div>\r\n              </>\r\n            )}\r\n\r\n            {!loading && !error && !requirePassword && gallery && gallery.images.length === 0 && (\r\n              <div className=\"text-center text-white\">\r\n                <p className=\"text-lg mb-4\">该图册暂无图片</p>\r\n                <button\r\n                  onClick={handleClose}\r\n                  className=\"px-6 py-2 bg-white/10 hover:bg-white/20 rounded-lg transition-colors\"\r\n                >\r\n                  关闭\r\n                </button>\r\n              </div>\r\n            )}\r\n          </div>\r\n\r\n          {/* 底部区域：放大缩小控制器 + 缩略图 */}\r\n          {!loading && !error && !requirePassword && gallery && gallery.images.length > 0 && (\r\n            <div className=\"absolute bottom-0 left-0 right-0 z-10\">\r\n              {/* 放大缩小按钮 - 仅电脑端显示 */}\r\n              {!isMobile && (\r\n                <div className=\"flex justify-center pb-3\">\r\n                  <div className=\"flex items-center gap-1.5 bg-black/50 backdrop-blur-sm rounded-full px-3 py-1.5\">\r\n                    <button\r\n                      onClick={handleZoomOut}\r\n                      className=\"p-1 hover:bg-white/10 rounded-full transition-colors\"\r\n                      title=\"缩小\"\r\n                    >\r\n                      <ZoomOut className=\"w-4 h-4 text-white\" />\r\n                    </button>\r\n\r\n                    <span className=\"text-white text-xs min-w-[50px] text-center font-medium\">\r\n                      {Math.round(zoom * 100)}%\r\n                    </span>\r\n\r\n                    <button\r\n                      onClick={handleZoomIn}\r\n                      className=\"p-1 hover:bg-white/10 rounded-full transition-colors\"\r\n                      title=\"放大\"\r\n                    >\r\n                      <ZoomIn className=\"w-4 h-4 text-white\" />\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              )}\r\n\r\n              {/* 底部缩略图 */}\r\n              {gallery.images.length > 1 && (\r\n                <div className=\"bg-gradient-to-t from-black/80 to-transparent p-4\">\r\n                  <div className=\"flex justify-center max-w-7xl mx-auto\">\r\n                    <div\r\n                      ref={thumbnailContainerRef}\r\n                      className=\"flex gap-2 overflow-x-auto hide-scrollbar\"\r\n                      style={{\r\n                        scrollbarWidth: 'none',\r\n                        msOverflowStyle: 'none',\r\n                        WebkitOverflowScrolling: 'touch'\r\n                      }}\r\n                    >\r\n                      {gallery.images.map((image, index) => (\r\n                        <button\r\n                          key={image.id}\r\n                          ref={(el) => { thumbnailRefs.current[index] = el; }}\r\n                          onClick={() => {\r\n                            setCurrentImageIndex(index);\r\n                            resetZoomAndPosition();\r\n                          }}\r\n                          className={`flex-shrink-0 w-16 h-16 rounded-lg overflow-hidden border-2 transition-all ${\r\n                            index === currentImageIndex\r\n                              ? 'border-primary-500 opacity-100'\r\n                              : 'border-white/20 opacity-50 hover:opacity-75'\r\n                          }`}\r\n                        >\r\n                          <img\r\n                            src={getFileUrl(image.path)}\r\n                            alt={image.filename}\r\n                            className=\"w-full h-full object-cover\"\r\n                            draggable={false}\r\n                          />\r\n                        </button>\r\n                      ))}\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </div>\r\n          )}\r\n        </div>\r\n      </motion.div>\r\n    </AnimatePresence>\r\n  );\r\n\r\n  if (typeof window !== 'undefined') {\r\n    return createPortal(modalContent, document.body);\r\n  }\r\n\r\n  return null;\r\n}\r\n"],"names":[],"mappings":"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"}