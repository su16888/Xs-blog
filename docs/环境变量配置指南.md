# Xs-Blog 环境变量配置指南

---

## 📋 概述

本指南详细说明了如何通过环境变量配置 Xs-Blog 系统的端口、域名和 IP 地址，**适用于生产环境部署包**。

### ✨ 优化亮点

- ✅ **零硬编码**：所有端口/域名/IP 均可通过环境变量配置
- ✅ **配置灵活**：打包后仍可通过 .env 文件轻松修改配置
- ✅ **灵活部署**：支持多种部署场景（同服务器、分离部署、云部署）
- ✅ **自动检测**：支持自动检测当前域名，减少配置工作
- ✅ **向后兼容**：完全兼容3.0.0之前旧版本配置方式

---

## 🎯 快速开始

> **前提：需要在后端 `backend/.env`中配置`AUTH_CODE`授权码，可联系作者获取**

### 场景一：前后端同服务器部署（推荐）

**最简配置**，只需修改数据库密码和 JWT 密钥：

#### 后端配置 `backend/.env`

```bash
# 服务器配置
PORT=3001                    # 后端端口
HOST=localhost               # 主机地址
FRONTEND_PORT=3000           # 前端端口

# CORS 配置（留空即可，自动检测）
CORS_ORIGIN=

# JWT 配置
JWT_SECRET=生成的随机密钥    # ⚠️ 必须修改（至少32位）
```

#### 前端配置 `frontend/.env.production`

```bash
# 前端端口
PORT=3000

# API 配置（使用自动检测模式）
NEXT_PUBLIC_BACKEND_PORT=3001
```

**说明**：
- 前端会自动使用当前访问的域名 + 后端端口
- 例如：访问 `http://192.168.1.100:3000` → 自动连接 `http://192.168.1.100:3001/api`
- 无需手动配置域名或 IP

---

### 场景二：前后端分离部署

#### 后端配置 `backend/.env`

```bash
# 服务器配置
PORT=3001
HOST=192.168.1.100           # 后端服务器 IP
FRONTEND_PORT=3000

# CORS 配置（指定前端地址）
CORS_ORIGIN=http://192.168.1.200:3000

# JWT 配置
JWT_SECRET=生成的随机密钥
```

#### 前端配置 `frontend/.env.production`

```bash
# 前端端口
PORT=3000

# API 配置（指定后端完整地址）
NEXT_PUBLIC_API_URL=http://192.168.1.100:3001/api
```

---

### 场景三：生产环境（使用域名）

#### 后端配置 `backend/.env`

```bash
# 服务器配置
PORT=3001
HOST=api.yourdomain.com
FRONTEND_PORT=443            # 前端使用 HTTPS 默认端口

# CORS 配置
CORS_ORIGIN=https://yourdomain.com,https://www.yourdomain.com

# JWT 配置
JWT_SECRET=生成的随机密钥

# 环境配置
NODE_ENV=production
```

#### 前端配置 `frontend/.env.production`

```bash
# 前端端口（Nginx 反向代理到 80/443）
PORT=3000

# API 配置
NEXT_PUBLIC_API_URL=https://api.yourdomain.com/api
```

---

### 场景四：Nginx 反向代理（相对路径，推荐）

**适用场景**：前后端通过 Nginx 统一代理，使用相对路径访问 API

#### 后端配置 `backend/.env`

```bash
# 服务器配置
PORT=3001
HOST=localhost
FRONTEND_PORT=3000

# CORS 配置（留空，自动检测）
CORS_ORIGIN=

# JWT 配置
JWT_SECRET=生成的随机密钥

# 环境配置
NODE_ENV=production
```

#### 前端配置 `frontend/.env.production`

```bash
# 前端端口
PORT=3000

# API 配置（使用相对路径）
NEXT_PUBLIC_API_URL=/api
```

#### Nginx 配置示例

```nginx
server {
    listen 80;
    server_name yourdomain.com;

    # 后端 API 代理
    location ^~ /api {
        proxy_pass http://127.0.0.1:3001/api;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 前端代理
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

**优势**：
- ✅ 前后端使用同一域名，无跨域问题
- ✅ 配置简单，只需设置相对路径
- ✅ 便于 HTTPS 部署
- ✅ 适合宝塔面板等可视化管理工具

---

## 📖 详细配置说明

### 后端环境变量 `backend/.env`

#### 数据库配置

Xs-Blog 支持三种数据库类型：MySQL、SQLite 和 PostgreSQL

| 变量名 | 说明 | 默认值 | 是否必填 |
|--------|------|--------|----------|
| `DB_TYPE` | 数据库类型（mysql、sqlite 或 postgres） | mysql | ❌ |

##### MySQL 配置（当 DB_TYPE=mysql 时）

| 变量名 | 说明 | 默认值 | 是否必填 |
|--------|------|--------|----------|
| `DB_HOST` | 数据库主机地址 | localhost | ❌ |
| `DB_PORT` | 数据库端口 | 3306 | ❌ |
| `DB_NAME` | 数据库名称 | xsblog888 | ❌ |
| `DB_USER` | 数据库用户名 | root | ❌ |
| `DB_PASSWORD` | 数据库密码 | （空） | ✅ |

##### SQLite 配置（当 DB_TYPE=sqlite 时）

| 变量名 | 说明 | 默认值 | 是否必填 |
|--------|------|--------|----------|
| `DB_PATH` | SQLite 数据库文件路径 | ./database/xsblog.db | ❌ |

##### PostgreSQL 配置（当 DB_TYPE=postgres 时）

| 变量名 | 说明 | 默认值 | 是否必填 |
|--------|------|--------|----------|
| `DB_HOST` | 数据库主机地址 | localhost | ❌ |
| `DB_PORT` | 数据库端口 | 5432 | ❌ |
| `DB_NAME` | 数据库名称 | xsblog | ❌ |
| `DB_USER` | 数据库用户名 | xsblog_user | ❌ |
| `DB_PASSWORD` | 数据库密码 | （空） | ✅ |

**数据库类型选择建议**：
- **MySQL**: 推荐用于生产环境，适合大量数据和高并发场景
- **SQLite**: 适合快速体验、开发环境和小型部署，无需安装额外数据库服务
- **PostgreSQL**: 企业级应用，适合高并发、数据一致性和完整性要求高的场景

**配置示例**：

```bash
# MySQL 配置
DB_TYPE=mysql
DB_HOST=localhost
DB_PORT=3306
DB_NAME=xsblog888
DB_USER=root
DB_PASSWORD=your_mysql_password

# SQLite 配置
DB_TYPE=sqlite
DB_PATH=./database/xsblog.db

# PostgreSQL 配置
DB_TYPE=postgres
DB_HOST=localhost
DB_PORT=5432
DB_NAME=xsblog
DB_USER=xsblog_user
DB_PASSWORD=your_postgres_password
```

#### 服务器配置

| 变量名 | 说明 | 默认值 | 是否必填 |
|--------|------|--------|----------|
| `PORT` | 后端服务端口 | 3001 | ❌ |
| `HOST` | 后端服务主机地址（用于日志显示） | localhost | ❌ |
| `FRONTEND_PORT` | 前端服务端口（用于 CORS 自动检测） | 3000 | ❌ |

#### CORS 配置

| 变量名 | 说明 | 示例 | 是否必填 |
|--------|------|------|----------|
| `CORS_ORIGIN` | 允许的前端地址 | 见下方说明 | ❌ |

**CORS_ORIGIN 配置方式**：

1. **留空**（推荐）：自动允许同服务器的前端请求
   ```bash
   CORS_ORIGIN=
   ```

2. **单个地址**：指定一个前端地址
   ```bash
   CORS_ORIGIN=http://192.168.1.100:3000
   ```

3. **多个地址**：用逗号分隔，无空格
   ```bash
   CORS_ORIGIN=http://example.com:3000,https://example.com,https://www.example.com
   ```

4. **允许所有**（仅开发测试用）
   ```bash
   CORS_ORIGIN=*
   ```

#### 文件 URL 配置

| 变量名 | 说明 | 示例 | 是否必填 |
|--------|------|------|----------|
| `FILE_BASE_URL` | 强制指定文件访问的基础 URL | http://localhost | ❌ |

**说明**：
- 通常不需要配置，系统会自动从请求中获取
- 仅在特殊情况下需要强制指定（如 CDN）

---

### 前端环境变量 `frontend/.env.production`

#### 基础配置

| 变量名 | 说明 | 默认值 | 是否必填 |
|--------|------|--------|----------|
| `PORT` | 前端服务端口 | 3000 | ❌ |

#### API 配置（四种方式，按优先级排序）

##### 方式一：完整 URL（优先级最高）

```bash
NEXT_PUBLIC_API_URL=http://localhost:3001/api
```

**适用场景**：
- ✅ 前后端分离部署
- ✅ 后端地址固定
- ✅ 最简单直接

**示例**：
```bash
# 本地开发
NEXT_PUBLIC_API_URL=http://localhost:3001/api

# 局域网部署
NEXT_PUBLIC_API_URL=http://192.168.1.100:3001/api

# 生产环境
NEXT_PUBLIC_API_URL=https://api.yourdomain.com/api
```

##### 方式二：拆分配置

```bash
NEXT_PUBLIC_API_HOST=localhost
NEXT_PUBLIC_API_PORT=3001
NEXT_PUBLIC_API_PROTOCOL=http
```

**适用场景**：
- ✅ 需要分别配置协议、主机、端口
- ✅ 灵活性高

**示例**：
```bash
# 本地开发
NEXT_PUBLIC_API_HOST=localhost
NEXT_PUBLIC_API_PORT=3001
NEXT_PUBLIC_API_PROTOCOL=http

# 生产环境
NEXT_PUBLIC_API_HOST=api.yourdomain.com
NEXT_PUBLIC_API_PORT=443
NEXT_PUBLIC_API_PROTOCOL=https
```

##### 方式三：自动检测模式（推荐）

```bash
NEXT_PUBLIC_BACKEND_PORT=3001
```

**适用场景**：
- ✅ 前后端部署在同一服务器
- ✅ 使用不同端口
- ✅ 零配置，自动适配

**工作原理**：
- 前端自动使用当前访问的域名 + 指定的后端端口
- 访问 `http://192.168.1.100:3000` → 连接 `http://192.168.1.100:3001/api`
- 访问 `https://yourdomain.com:3000` → 连接 `https://yourdomain.com:3001/api`

##### 方式四：服务端渲染降级配置

```bash
NEXT_PUBLIC_DEFAULT_HOST=localhost
NEXT_PUBLIC_DEFAULT_PROTOCOL=http
NEXT_PUBLIC_BACKEND_PORT=3001
```

**适用场景**：
- ✅ 服务端渲染时的默认配置
- ✅ 通常不需要配置

---

## 🔧 修改端口/域名/IP 的步骤

### 打包后修改配置

#### 步骤 1：修改后端配置

编辑 `backend/.env` 文件：

```bash
# 修改后端端口
PORT=8080

# 修改主机地址（可选）
HOST=192.168.1.100

# 修改前端端口（用于 CORS）
FRONTEND_PORT=8000

# 如果前后端分离，指定前端地址
CORS_ORIGIN=http://192.168.1.200:8000
```

#### 步骤 2：修改前端配置

编辑 `frontend/.env.production` 文件：

**选项 A：使用完整 URL**
```bash
PORT=8000
NEXT_PUBLIC_API_URL=http://192.168.1.100:8080/api
```

**选项 B：使用自动检测**
```bash
PORT=8000
NEXT_PUBLIC_BACKEND_PORT=8080
```

#### 步骤 3：重启服务

```bash
# 重启后端
pm2 restart xs-blog-backend

# 重启前端
pm2 restart xs-blog-frontend
```

**注意**：
- ✅ 无需重新构建代码
- ✅ 修改 .env 文件后重启即可生效
- ✅ 所有配置都是运行时读取的

---

## 📊 配置优先级

### 后端 CORS 配置优先级

1. ✅ **设置了 `CORS_ORIGIN`**：使用指定的地址
2. ✅ **未设置 `CORS_ORIGIN`**：自动允许同域名请求（使用 `FRONTEND_PORT`）

### 前端 API 配置优先级

1. ✅ **`NEXT_PUBLIC_API_URL`**：完整 URL（最高优先级）
2. ✅ **拆分配置**：`NEXT_PUBLIC_API_HOST` + `PORT` + `PROTOCOL`
3. ✅ **自动检测**：`NEXT_PUBLIC_BACKEND_PORT`（使用当前域名）
4. ✅ **默认值**：`localhost:3001`（降级方案）

---

## 🎨 配置示例

### 示例 1：简单配置

**后端 `backend/.env`**：
```bash
PORT=3001
HOST=localhost
FRONTEND_PORT=3000
CORS_ORIGIN=
```

**前端 `frontend/.env.production`**：
```bash
PORT=3000
NEXT_PUBLIC_API_URL=http://localhost:3001/api
```

---

### 示例 2：同服务器部署

**后端 `backend/.env`**：
```bash
PORT=3001
HOST=192.168.1.100
FRONTEND_PORT=3000
CORS_ORIGIN=
```

**前端 `frontend/.env.production`**：
```bash
PORT=3000
NEXT_PUBLIC_BACKEND_PORT=3001
```

**访问**：`http://192.168.1.100:3000`

---

### 示例 3：分离服务器部署

**后端服务器（192.168.1.100）`backend/.env`**：
```bash
PORT=3001
HOST=192.168.1.100
FRONTEND_PORT=3000
CORS_ORIGIN=http://192.168.1.200:3000
```

**前端服务器（192.168.1.200）`frontend/.env.production`**：
```bash
PORT=3000
NEXT_PUBLIC_API_URL=http://192.168.1.100:3001/api
```

---

### 示例 4：Nginx 反代部署

**后端 `backend/.env`**：
```bash
PORT=3001
HOST=api.yourdomain.com
FRONTEND_PORT=443
CORS_ORIGIN=https://yourdomain.com,https://www.yourdomain.com
NODE_ENV=production
```

**前端 `frontend/.env.production`**：
```bash
PORT=3000
NEXT_PUBLIC_API_URL=https://api.yourdomain.com/api
```

**Nginx 配置示例**：
```nginx
# 前端
server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

# 后端
server {
    listen 80;
    server_name api.yourdomain.com;

    location / {
        proxy_pass http://localhost:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

---

### 示例 5：自定义端口

**后端 `backend/.env`**：
```bash
PORT=8080
HOST=localhost
FRONTEND_PORT=8000
CORS_ORIGIN=
```

**前端 `frontend/.env.production`**：
```bash
PORT=8000
NEXT_PUBLIC_BACKEND_PORT=8080
```

**访问**：`http://localhost:8000`

---

## ⚠️ 常见问题

### 1. 修改配置后不生效？

**原因**：未重启服务

**解决**：
```bash
pm2 restart xs-blog-backend
pm2 restart xs-blog-frontend
```

---

### 2. CORS 跨域错误？

**错误信息**：`Access-Control-Allow-Origin`

**原因**：前后端分离部署时，后端未配置前端地址

**解决**：
```bash
# backend/.env
CORS_ORIGIN=http://前端服务器IP:前端端口
```

---

### 3. 前端无法连接后端？

**检查清单**：
- ✅ 后端服务是否已启动
- ✅ 防火墙是否开放端口
- ✅ 前端 API 配置是否正确
- ✅ 后端 CORS 配置是否正确

**调试方法**：
```bash
# 检查后端是否运行
curl http://localhost:3001/health

# 查看前端日志
pm2 logs xs-blog-frontend

# 查看后端日志
pm2 logs xs-blog-backend
```

---

### 4. 如何修改配置？

**答案**：直接修改 .env 文件即可！

**说明**：
- ✅ 所有配置都是运行时从 .env 文件读取的
- ✅ 代码打包不影响环境变量的读取
- ✅ 修改后重启服务即可生效
- ❌ 无需重新构建代码

---

## 🔒 安全建议

1. ✅ **生产环境使用 HTTPS**
   ```bash
   NEXT_PUBLIC_API_PROTOCOL=https
   ```

2. ✅ **限制 CORS 来源**
   ```bash
   # ❌ 不要在生产环境使用
   CORS_ORIGIN=*

   # ✅ 明确指定允许的域名
   CORS_ORIGIN=https://yourdomain.com
   ```

3. ✅ **使用强密码的 JWT_SECRET**
   ```bash
   # 生成随机密钥
   node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
   ```

---

## 📚 相关文档

- [部署指南.md](docs/部署指南.md) - 部署相关说明
- [常见问题解决方案.md](docs/常见问题解决方案.md) - 问题排查和解决方案

---

## 🎯 总结

### 核心优势

- ✅ **零硬编码**：所有端口/域名/IP 均可配置
- ✅ **打包友好**：打包后仍可通过 .env 修改
- ✅ **灵活部署**：支持多种部署场景
- ✅ **自动检测**：减少配置工作

### 推荐配置方式

|   部署场景   |     推荐方式      | 配置复杂度 |
| ----------- | ---------------- | --------- |
| 简易部署     | 完整 URL         | ⭐        |
| 同服务器部署 | 自动检测          | ⭐        |
| 分离部署     | 完整 URL         | ⭐⭐     |
| 正式部署     | 完整 URL + Nginx | ⭐⭐⭐   |